name: Build Backend

on:
  push:
    branches: [ main ]
    paths:
      - "backend/**"
      - ".github/workflows/build-backend.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Normalize repository name
        run: echo "REPO_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Build & push image
        run: |
          REPO="ghcr.io/${{ env.REPO_NAME }}/cvb-backend:latest"
          docker build -t $REPO backend/
          docker push $REPO

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Install SSH
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Droplet
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "\
            cd /opt/certificado-verde-blockchain && \
            git pull origin main && \
            docker compose pull backend && \
            docker compose up -d --no-deps --force-recreate backend && \
            docker exec backend-server poetry run alembic upgrade head && \
            docker image prune -f \
          "
